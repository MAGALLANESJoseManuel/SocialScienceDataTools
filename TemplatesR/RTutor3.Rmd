R TUTORIAL (III)
========================================================
```{r echo=FALSE, set-options }
options(width = 320)
```
When data you need is from different sources, you will nedd to have a clear integration strategy. For this section we will collect some data from the web, clean them and combine them into a single file.

As I will need to **scrap** many data sites, it is important to create a procedure that improves readability and makes coding more efficient. This function will look like this:

```{r }
scrapData <- function(linkWhere,whichTable,toFactor=FALSE) 
  {  require(XML) 
     dirtyTable <- getNodeSet(htmlParse(linkWhere),"//table") [[whichTable]]
     tableToReturn <- readHTMLTable(dirtyTable,   #the generated above
                                    header=TRUE,  #first line is the header
                                    trim=TRUE,    #eliminate leading and trailing white spaces in cells
                                    stringsAsFactors = toFactor #do not convert strings to factors
                                    ) }

```

I took care to organise the input parameters in such a way that it is flexible to the way the data in the web page is presented. As it is clear from the function, we always need to provide a *link* and to indicate *which table* to scrap, and optionally inform if we need to convert strings to factors.

Suppose that in this tutorial I want to organise some data at a country level by integrating some composite indexes. In this case, I will use the Indices of Freedom :
<img src="http://i.imgur.com/hm7jOcA.png?1"height="500" width="800" align=center> 

And the Global terrorism index:  
<img src="http://i.imgur.com/I5BwHJN.png"height="500" width="500" align=center> 

Since I think it might be neccessary some information on the location of the countries, I will get the region of the country from **cloford.com**:

<img src="http://i.imgur.com/uJTk7Qx.png"height="500" width="800" align=center> 

So, these are links needed:
```{r message=FALSE}
freedomLink = "http://en.wikipedia.org/wiki/List_of_Indices_of_Freedom"
terrorismLink = "http://en.wikipedia.org/wiki/Global_Terrorism_Index"
regionsLink="http://cloford.com/resources/codes/"
```

Next, I apply the function to them:
```{r}
Freedom<-scrapData(freedomLink,3)
Terrorism<-scrapData(terrorismLink,1)
Regions<-scrapData(regionsLink,5)
```

I also have the Human Development Index in a web repository in a simple csv format:

```{r message=FALSE}
library(RCurl)
data <- getURL("https://raw.github.com/MAGALLANESJoseManuel/SocialScienceDataTools/master/TemplatesR/hdi.csv")
HDI <- read.csv(text = data)
```

I combine the 3 data sets into *dataCountries*. For that, I have identified that they all have a column named "Country": 
```{r}
dataCountries <- merge(Regions, Freedom, by= "Country")
dataCountries <- merge(dataCountries, Terrorism, by= "Country")
dataCountries <- merge(dataCountries, HDI, by= "Country")
```
Let's see what is the result so far:
```{r}
str(dataCountries)
```


It is important to notice that the every dataset had different number of countries, I will not do the cleaning of that (but should be done). So, I am conscious that I will have a smaller set of countries. For now, let's play attention to what variables I have:
```{r}
str(dataCountries)
```
There are some variables I do not want, so I make them dissapear:
```{r}
dataCountries <- dataCountries[c(-4:-10,-13,-15)] #I do not want these variable
```

Following, I alter the names of the variables:
```{r}
names(dataCountries)=c("Country","Continent", "Region","Freedom","FreeMarket","Democracy","Terrorism", "HDI")
```

These is what I have so far:
```{r}
summary(dataCountries)
str(dataCountries)
head(dataCountries)
```
We see nonstandard **n/a** values, and a mix of **number and category** which may bear trouble later, and also some columns should be read as factors and numbers but those are being read as characters, so we better change all of that.

First we get find the cells that use "n/a", get the index and then go back to the cell and eliminate that:
```{r}
for (i in 3:8){
indexes=c(grep("/", dataCountries[,i])) # where is it?
if (length(indexes)>1)
  dataCountries[indexes,i]=NA      # making the change  
} 
```

In similar fashion we can find the cell whose that starts with a number and a space, and replace that combination by *nothing*:
```{r}
for (i in 1:7){
  dataCountries[i]=sub("[0-9]+ ", "", dataCountries[,i]) 
}
```

Finally,we change the type of the columns:
```{r}
for (i in 2:7) {
  if (i>6) {dataCountries[,i]=as.double(dataCountries[,i])}
  else {dataCountries[,i]=as.factor(dataCountries[,i])}
}
summary(dataCountries)
```

But, we will only wish to have those countries with all the indexes, which will finally save as a csv file:
```{r}
dataCountries=na.omit(dataCountries)
setwd("~/Documents/GITHUBrepositories/Tutorials/TemplatesR")
write.csv(dataCountries,"dataCountries.csv",row.names=FALSE)
```

You can access this data with the code:
```{r}
library(RCurl)
DATA_GithubCleaned <- getURL("https://raw.github.com/MAGALLANESJoseManuel/SocialScienceDataTools/master/TemplatesR/dataCountries.csv")
DATA_gitClean <- read.csv(text = DATA_GithubCleaned)
head(DATA_gitClean)
str(DATA_gitClean)

```